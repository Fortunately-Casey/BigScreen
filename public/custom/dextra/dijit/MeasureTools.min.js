define("dextra/dijit/MeasureTools",["dojo/dom","dojo/query","dojo/_base/declare","dojo/_base/lang","dijit/_WidgetBase","dojo/on","esri/graphic","esri/layers/GraphicsLayer","esri/toolbars/draw","esri/Color","esri/symbols/Font","esri/geometry/Polyline","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/TextSymbol","esri/geometry/geometryEngine","esri/InfoTemplate"],function(m,c,o,r,a,e,g,i,k,q,n,h,p,l,f,b,d){var j=o(a,{declaredClass:"dextra.dijit.MeasureTools",defaults:{map:null,lineSymbol:new l(l.STYLE_SOLID,new q("#FFA500"),2),markerSymbol:new p(p.STYLE_CIRCLE,10,new l(l.STYLE_SOLID,new q("#DC143C"),2),new q("#FFA500"))},srcRefNode:null,toolbar:null,_stopPoints:null,_stopDistances:null,_measureLayer:null,_mapClickFlag:null,constructor:function(t,s){o.safeMixin(this.defaults,t);this.srcRefNode=s;this._measureLayer=new i();this.defaults.map.addLayer(this._measureLayer);this._initalToolbar();this._initialMeasureLayer()},_initialMeasureLayer:function(){this._measureLayer.on("mouse-over",r.hitch(this,function(s){var t=s.graphic;if(t.symbol.isClearBtn){this.defaults.map.setMapCursor("pointer");e.once(t.getShape(),"click",r.hitch(this,function(){this._measureLayer.clear();this.defaults.map.setMapCursor("default")}))}}));this._measureLayer.on("mouse-out",r.hitch(this,function(s){this.defaults.map.setMapCursor("default")}))},_initalToolbar:function(){var s=this.defaults.map;this.toolbar=new k(s,{showTooltips:false});this.toolbar.on("draw-complete",r.hitch(this,this._drawComplete));c("#measure-distance").on("click",r.hitch(this,this._startMeasureDistance));c("#measure-area").on("click",r.hitch(this,this._startMeasureArea))},_drawComplete:function(s){if(s.geometry.type=="polygon"){this._endMeasureArea(s.geometry)}else{var t=this._stopPoints[this._stopPoints.length-1];this._endMeasureDistance(s.geometry,t)}this.toolbar.deactivate();this._enableInfoTemp()},_startMeasureDistance:function(){this._clearMapMouseClickEvent();this._disableInfoTemp();this._stopPoints=[];this._stopDistances=[];this._measureLayer.clear();this.toolbar.deactivate();this.toolbar.activate(k.POLYLINE);var t=this._stopPoints;var u=this._stopDistances;var s=this;this._mapClickFlag=this.defaults.map.on("click",function(v){var A=0;var z=v.mapPoint;if(t.length>0){var x=t[t.length-1];A=s._calDistance(x,z);if(s._stopDistances.length>0){A+=s._stopDistances[s._stopDistances.length-1]}u.push(A)}t.push(z);var w=new g(z,s.defaults.markerSymbol);var y=s._getStopPointGraphic(z,A);s._measureLayer.add(w);s._measureLayer.add(y)})},_endMeasureDistance:function(t,u){var v=new g(t,this.toolbar.lineSymbol);var s=this._createClearBtn(u);this._measureLayer.add(s);this._measureLayer.add(v);v.getDojoShape().moveToBack();this._clearMapMouseClickEvent()},_getStopPointGraphic:function(u,t){var s=this._createTextSymbol("起点");if(t>0&&t>=1000){s=s.setText((t/1000).toFixed(2)+"km")}else{if(t>0&&t<1000){s=s.setText(t.toFixed()+"m")}}return new g(u,s)},_calDistance:function(u,t){var s=new h(this.defaults.map.spatialReference);s.addPath([u,t]);if(this.defaults.map.spatialReference.isWebMercator()||this.defaults.map.spatialReference.wkid=="4326"){return b.geodesicLength(s,"meters")}else{return b.planarLength(s,"meters")}},_startMeasureArea:function(){this._clearMapMouseClickEvent();this._disableInfoTemp();this._measureLayer.clear();this.toolbar.deactivate();this.toolbar.activate(k.POLYGON)},_endMeasureArea:function(v){var x=this._calArea(v);if(x>1000000){x=(x/1000000).toFixed(2)+"平方千米"}else{x=x.toFixed(2)+"平方米"}var t=v.getCentroid();var s=new g(v,this.toolbar.fillSymbol);var w=this._createTextSymbol(x);w.setOffset(30,10);var y=new g(t,w);var u=this._createClearBtn(t);this._measureLayer.add(s);this._measureLayer.add(y);this._measureLayer.add(u);s.getDojoShape().moveToBack()},_calArea:function(s){var t=this.defaults.map.spatialReference;if(t.isWebMercator()||t.wkid=="4326"){return b.geodesicArea(s,"square-meters")}else{return b.planarArea(s,"square-meters")}},_createClearBtn:function(s){var u="M13.618,2.397 C10.513,-0.708 5.482,-0.713 2.383,2.386 C-0.718,5.488 -0.715,10.517 2.392,13.622 C5.497,16.727 10.529,16.731 13.627,13.632 C16.727,10.533 16.724,5.502 13.618,2.397 L13.618,2.397 Z M9.615,11.351 L7.927,9.663 L6.239,11.351 C5.55,12.04 5.032,12.64 4.21,11.819 C3.39,10.998 3.987,10.48 4.679,9.79 L6.367,8.103 L4.679,6.415 C3.989,5.726 3.39,5.208 4.21,4.386 C5.032,3.566 5.55,4.165 6.239,4.855 L7.927,6.541 L9.615,4.855 C10.305,4.166 10.82,3.565 11.642,4.386 C12.464,5.208 11.865,5.726 11.175,6.415 L9.487,8.102 L11.175,9.789 C11.864,10.48 12.464,10.998 11.642,11.819 C10.822,12.64 10.305,12.04 9.615,11.351 L9.615,11.351 Z";var v="#b81b1b";var t=new p();t.setOffset(-40,15);t.setPath(u);t.setColor(new q(v));t.setOutline(null);t.isClearBtn=true;return g(s,t)},_createTextSymbol:function(w){var v=new q("#b11800");var t=new q("#fff");var s=new n("12pt",n.STYLE_NORMAL,n.VARIANT_NORMAL,n.WEIGHT_BOLD,"微软雅黑");var u=new f(w,s,v);u.setAlign(f.ALIGN_MIDDLE);return u},_clearMapMouseClickEvent:function(){if(this._mapClickFlag!=null){this._mapClickFlag.remove()}},_disableInfoTemp:function(){ckfwx.infoTemplate=null;hffwx.infoTemplate=null;dgxfwx.infoTemplate=null;xmfbfw.infoTemplate=null},_enableInfoTemp:function(){var v=new d();v.setTitle("出库申请范围线");v.setContent("<b>项目名称: </b>${XMMC}<br><b>合同编号: </b>${HTBH}<br><b>任务编号: </b>${RWBH}<br><b>申请人: </b>${SQR}<br><b>申请日期: </b>${SQDATE:DateFormat(datePattern:'yyyy年M月d日',selector:'date')}<br><b>锁定状态: </b>${SDZT}<br><b>是否提供数据: </b>${SJYTG}<br><b>数据面积: </b>${SJMJ:NumberFormat(round:2)}平方米");ckfwx.infoTemplate=v;var u=new d();u.setTitle("航飞拍摄区域");u.setContent("<b>项目名称: </b>${XMMC}<br><b>合同编号: </b>${HTBH}${RWBH}<br><b>采集人: </b>${CJR}<br><b>拍摄时间: </b>${CJDATE:DateFormat(datePattern:'yyyy年M月d日',selector:'date')}<br><b>数据说明: </b>${SJSM}");hffwx.infoTemplate=u;var s=new d();s.setTitle("待更新区域");s.setContent("<b>提供人: </b>${TGR}<br><b>提供日期: </b>${TGDATE:DateFormat(datePattern:'yyyy年M月d日',selector:'date')}<br><b>情况说明: </b>${QKSM}");dgxfwx.infoTemplate=s;var t=new d();t.setTitle("项目分布区域");t.setContent("<b>项目名称: </b>${XMMC}<br><b>合同编号: </b>${HTBH}<br><b>采集人: </b>${SQR}<br><b>项目类型: </b>${SJLX}<br><b>项目状态: </b>${XMZT}");xmfbfw.infoTemplate=t}});return j});